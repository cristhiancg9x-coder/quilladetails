---
import Layout from '../layouts/Layout.astro';
import Navbar from '../components/Navbar.astro';
import { supabase } from '../lib/supabase';

// --- Lógica del Servidor (Upload) ---
if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData();
  const imageFile = formData.get("image") as File;
  const title = formData.get("title") as string;
  const description = formData.get("description") as string;

  // 1. Obtener usuario actual
  const accessToken = Astro.cookies.get("sb-access-token");
  const refreshToken = Astro.cookies.get("sb-refresh-token");
  
  if (!accessToken || !refreshToken) return Astro.redirect("/");

  const { data: { session } } = await supabase.auth.setSession({
    access_token: accessToken.value,
    refresh_token: refreshToken.value,
  });

  if (!session) return Astro.redirect("/");

  // 2. Subir imagen al Bucket 'posts'
  // Creamos un nombre único: id-usuario/fecha-random.png
  const fileName = `${session.user.id}/${Date.now()}-${imageFile.name}`;
  
  const { data: uploadData, error: uploadError } = await supabase.storage
    .from('posts')
    .upload(fileName, imageFile);

  if (uploadError) {
    console.error("Error subiendo imagen:", uploadError);
  } else {
    // 3. Obtener URL pública de la imagen
    const { data: { publicUrl } } = supabase.storage.from('posts').getPublicUrl(fileName);

    // 4. Guardar datos en la tabla 'posts'
    const { error: dbError } = await supabase.from('posts').insert({
      user_id: session.user.id,
      title: title,
      description: description,
      image_url: publicUrl
    });

    if (!dbError) {
      return Astro.redirect("/feed");
    }
  }
}
---

<Layout title="Subir Manualidad - QuillaDetails">
  <Navbar />
  
  <main class="min-h-screen pb-24 flex flex-col items-center justify-center p-4">
    
    <div class="w-full max-w-md">
      <h1 class="text-3xl font-bold text-center mb-6 text-white">
        Nueva <span class="text-cyber-rose">Creación</span>
      </h1>

      <form method="POST" enctype="multipart/form-data" class="
        flex flex-col gap-6 p-8
        bg-white/10 backdrop-blur-xl border border-white/20 rounded-3xl
        shadow-[0_0_40px_rgba(255,0,127,0.1)]
      ">
        
        <div class="relative group cursor-pointer">
          <input 
            type="file" 
            name="image" 
            id="imageInput" 
            accept="image/*" 
            required
            class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"
          />
          
          <div id="previewContainer" class="
            w-full h-64 border-2 border-dashed border-white/30 rounded-2xl
            flex flex-col items-center justify-center text-gray-300
            group-hover:border-cyber-rose group-hover:text-cyber-rose transition-colors
            overflow-hidden bg-black/20
          ">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            <span class="text-sm font-medium">Toca para subir foto</span>
            <img id="imagePreview" class="hidden w-full h-full object-cover" />
          </div>
        </div>

        <div>
          <label class="block text-cyber-rose text-sm font-bold mb-2 ml-1">TÍTULO</label>
          <input 
            type="text" 
            name="title" 
            placeholder="Ej: Lámpara de Resina" 
            required
            class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-cyber-rose transition-colors"
          />
        </div>

        <div>
          <label class="block text-gray-400 text-sm font-bold mb-2 ml-1">DESCRIPCIÓN</label>
          <textarea 
            name="description" 
            rows="3"
            placeholder="Cuéntanos cómo lo hiciste..." 
            class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-cyber-rose transition-colors"
          ></textarea>
        </div>

        <button type="submit" class="
          w-full py-4 mt-2
          bg-gradient-to-r from-cyber-rose to-purple-600
          text-white font-bold rounded-xl text-lg tracking-wide
          shadow-lg hover:shadow-cyber-rose/50 transform hover:scale-[1.02] transition-all
        ">
          PUBLICAR
        </button>

      </form>
    </div>
  </main>
</Layout>

<script>
  // Script simple para mostrar la previsualización de la imagen
  const input = document.getElementById('imageInput') as HTMLInputElement;
  const preview = document.getElementById('imagePreview') as HTMLImageElement;
  const container = document.getElementById('previewContainer');
  
  if (input && preview && container) {
      input.addEventListener('change', () => {
        const file = input.files?.[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            preview.src = e.target?.result as string;
            preview.classList.remove('hidden');
            // Ocultamos el icono y texto original
            const svg = container.querySelector('svg');
            const span = container.querySelector('span');
            if(svg) svg.style.display = 'none';
            if(span) span.style.display = 'none';
          }
          reader.readAsDataURL(file);
        }
      });
  }
</script>